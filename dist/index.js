"use strict";var f=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var y=(i,t)=>{for(var e in t)f(i,e,{get:t[e],enumerable:!0})},v=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of w(t))!O.call(i,s)&&s!==e&&f(i,s,{get:()=>t[s],enumerable:!(r=C(t,s))||r.enumerable});return i};var P=i=>v(f({},"__esModule",{value:!0}),i);var S={};y(S,{Bucketsd:()=>h});module.exports=P(S);var n=require("@confluentinc/kafka-javascript"),l=require("buffer"),b=require("buckets"),m=require("events");function T(i,t){return i.topics.filter(e=>t.some(r=>typeof r=="string"?e.name===r:r instanceof RegExp?r.test(e.name):!1))}function d(i,t){return new Promise((e,r)=>i.getMetadata(t,(s,o)=>s?r(s):e(o)))}function g(i,t){return T(i,t).flatMap(r=>r.partitions.map(s=>({topic:r.name,partition:s.id,offset:0})))}var h=class{constructor(t){this.initialized=!1;this.watermarks=new Map;this.topicOffsets=new Map;let{createTopicOptions:e,appId:r,brokers:s,store:o,consumer:c,producer:a}=t;this.topic=e?e.topic:`${r}.kv`,this.appId=r,this.createTopicOptions=e,this.store=new b.Store(`db/${r}`,{cache:!0,...o}),this.store.on("change",p=>this.handleStoreChange(p));let u=Array.isArray(s)?s.join(","):"localhost:19092";this.consumer=new n.KafkaConsumer({"group.id":"kv","bootstrap.servers":u,"enable.auto.commit":!1,"enable.auto.offset.store":!1,...c?.global},{"auto.offset.reset":"beginning",...c?.topic||{}}),this.producer=new n.Producer({"bootstrap.servers":u,...a?.global},{...a?.topic}),this.producer.setPollInterval(10)}handleStoreChange(t){let{op:e,bucket:r,id:s,value:o,ttl:c}=t,a=[];e&&a.push({op:e}),r&&a.push({bucket:r}),c&&a.push({ttl:c});let u=e==="remove"?null:l.Buffer.isBuffer(o)?o:l.Buffer.from(o);try{this.producer.produce(this.topic,null,u,s,Date.now(),null,a)}catch(p){let k=p;if(n.CODES.ERRORS.ERR__QUEUE_FULL===k.code)console.log("Queue full, re-buffering message"),this.producer.poll();else throw p}}queryWatermark(t){return new Promise((e,r)=>{this.consumer.queryWatermarkOffsets(this.topic,t,5e3,(s,o)=>{if(s)return r(s);console.log("queryWatermarkOffsets",{partition:t,offsets:o}),this.watermarks.set(t,Number(o.highOffset)),this.topicOffsets.set(t,-1),e()})})}async setupPartitionStatus(t){await Promise.all(t.map(({partition:e})=>this.queryWatermark(e))),console.log("Partition status initialized:",this.watermarks)}async start(){this.consumer.setDefaultConsumeTimeout(1e3),this.consumer.connect(),this.producer.connect(),await Promise.all([(0,m.once)(this.consumer,"ready"),(0,m.once)(this.producer,"ready")]),n.AdminClient.createFrom(this.consumer).createTopic({num_partitions:5,replication_factor:3,config:{"segment.ms":"300000","segment.bytes":"102400","cleanup.policy":"compact"},...this.createTopicOptions,topic:this.topic},async e=>{if(e&&e.code!==n.CODES.ERRORS.ERR_TOPIC_ALREADY_EXISTS)throw e;let r=await d(this.consumer,{}),s=g(r,[this.topic]);this.consumer.assign(s),await this.setupPartitionStatus(s),this.consumer.consume(),this.consumer.on("data",o=>this.handleConsumerData(o))}),await this.waitUntilCaughtUp()}handleConsumerData(t){this.topicOffsets.set(t.partition,t.offset);let e=t.headers?.reduce((r,s)=>{let o=Object.keys(s)[0];return r[o]=s[o].toString(),r},{});if(t.key&&e?.bucket&&e?.op){let r=this.store.bucket(e.bucket,{encoding:"json"});e.op==="put"?r.put(t.key.toString(),t.value,{quiet:!0}):r.remove(t.key.toString(),{quiet:!0})}}waitUntilCaughtUp(){return new Promise(t=>{let e=setInterval(()=>{this.hasCaughtUp()&&(clearInterval(e),console.log("All partitions caught up. KV is ready."),this.initialized=!0,t())},1e3)})}hasCaughtUp(){return Array.from(this.watermarks.entries()).every(([t,e])=>{let r=this.topicOffsets.get(t);return r!==void 0&&r>=e-1})}async stop(){this.consumer.unsubscribe(),this.consumer.pause(this.consumer.assignments()),this.producer.flush(5e3,t=>{console.log(t),this.producer.disconnect(),this.consumer.disconnect()}),await Promise.all([this.consumer,this.producer].map(t=>(0,m.once)(t,"disconnected")))}};0&&(module.exports={Bucketsd});
//# sourceMappingURL=index.js.map