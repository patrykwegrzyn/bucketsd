"use strict";var f=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var O=(i,t)=>{for(var e in t)f(i,e,{get:t[e],enumerable:!0})},y=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of C(t))!w.call(i,r)&&r!==e&&f(i,r,{get:()=>t[r],enumerable:!(s=k(t,r))||s.enumerable});return i};var v=i=>y(f({},"__esModule",{value:!0}),i);var T={};O(T,{Bucketsd:()=>h});module.exports=v(T);var n=require("@confluentinc/kafka-javascript"),l=require("buffer"),b=require("buckets"),p=require("events");function P(i,t){return i.topics.filter(e=>t.some(s=>typeof s=="string"?e.name===s:s instanceof RegExp?s.test(e.name):!1))}function d(i,t){return new Promise((e,s)=>i.getMetadata(t,(r,o)=>r?s(r):e(o)))}function g(i,t){return P(i,t).flatMap(s=>s.partitions.map(r=>({topic:s.name,partition:r.id,offset:0})))}var h=class{constructor(t){this.initialized=!1;this.watermarks=new Map;this.topicOffsets=new Map;let{createTopicOptions:e,appId:s,brokers:r,store:o,consumer:c,producer:a}=t;this.topic=e?e.topic:`${s}.kv`,this.appId=s,this.createTopicOptions=e,this.store=new b.Store(`db/${s}`,{cache:!0,...o}),this.store.on("change",m=>this.handleStoreChange(m));let u=Array.isArray(r)?r.join(","):"localhost:19092";this.consumer=new n.KafkaConsumer({"group.id":"kv","bootstrap.servers":u,"enable.auto.commit":!1,"enable.auto.offset.store":!1,...c?.global},{"auto.offset.reset":"beginning",...c?.topic||{}}),this.producer=new n.Producer({"bootstrap.servers":u,...a?.global},{...a?.topic})}handleStoreChange(t){let{op:e,bucket:s,id:r,value:o,ttl:c}=t,a=[];e&&a.push({op:e}),s&&a.push({bucket:s}),c&&a.push({ttl:c});let u=e==="remove"?null:l.Buffer.isBuffer(o)?o:l.Buffer.from(o);console.log({messageValue:u});let m=this.producer.produce(this.topic,null,u,r,Date.now(),null,a);console.log({res:m})}queryWatermark(t){return new Promise((e,s)=>{this.consumer.queryWatermarkOffsets(this.topic,t,5e3,(r,o)=>{if(r)return s(r);console.log("queryWatermarkOffsets",{partition:t,offsets:o}),this.watermarks.set(t,Number(o.highOffset)),this.topicOffsets.set(t,-1),e()})})}async setupPartitionStatus(t){await Promise.all(t.map(({partition:e})=>this.queryWatermark(e))),console.log("Partition status initialized:",this.watermarks)}async start(){this.consumer.setDefaultConsumeTimeout(1e3),this.consumer.connect(),this.producer.connect(),await Promise.all([(0,p.once)(this.consumer,"ready"),(0,p.once)(this.producer,"ready")]),n.AdminClient.createFrom(this.consumer).createTopic({num_partitions:5,replication_factor:3,config:{"segment.ms":"300000","segment.bytes":"102400","cleanup.policy":"compact"},...this.createTopicOptions,topic:this.topic},async e=>{if(e&&e.code!==n.CODES.ERRORS.ERR_TOPIC_ALREADY_EXISTS)throw e;let s=await d(this.consumer,{}),r=g(s,[this.topic]);this.consumer.assign(r),await this.setupPartitionStatus(r),this.consumer.consume(),this.consumer.on("data",o=>this.handleConsumerData(o))}),await this.waitUntilCaughtUp()}handleConsumerData(t){this.topicOffsets.set(t.partition,t.offset);let e=t.headers?.reduce((s,r)=>{let o=Object.keys(r)[0];return s[o]=r[o].toString(),s},{});if(t.key&&e?.bucket&&e?.op){let s=this.store.bucket(e.bucket,{encoding:"json"});e.op==="put"?s.put(t.key.toString(),t.value,{quiet:!0}):s.remove(t.key.toString(),{quiet:!0})}}waitUntilCaughtUp(){return new Promise(t=>{let e=setInterval(()=>{this.hasCaughtUp()&&(clearInterval(e),console.log("All partitions caught up. KV is ready."),this.initialized=!0,t())},1e3)})}hasCaughtUp(){return Array.from(this.watermarks.entries()).every(([t,e])=>{let s=this.topicOffsets.get(t);return s!==void 0&&s>=e-1})}async stop(){this.consumer.unsubscribe(),this.consumer.pause(this.consumer.assignments()),this.producer.flush(5e3,t=>{console.log(t),this.producer.disconnect(),this.consumer.disconnect()}),await Promise.all([this.consumer,this.producer].map(t=>(0,p.once)(t,"disconnected")))}};0&&(module.exports={Bucketsd});
//# sourceMappingURL=index.js.map